{include file="public/head" /}
{include file="public/top" /}
<style type="text/css">
	form {
	  margin: 0 !important;
		display: inline-block !important;
	}
	thead{
		background: #fafafa;
	}
	table{
		width: 100%;
		margin-bottom: 20px;
		text-align: center;
		border: 1px solid #f0f0f0;
	}
	th,td{
		border: 1px dashed #f0f0f0;
		text-align: center;
	}
	th{
		height: 45px;
	}
	td{
		height: 62px;
	}
	.bbdd{
		position: fixed;
		z-index: 100001;
		width: 1000px;
		top: 35%;
		left: 50%;
		transform: translate(-50%,-50%);
		width: 400px;
		border:1px solid #e7e7e7;
		border-radius: 6px;
		background-color: #ffffff;
	}
	.ddhh{
		height: 52px;;
		line-height: 52px;
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		padding: 0 17px;
		box-sizing: border-box;
		/*border-bottom: 1px solid #e5e5e5;*/
		color: #333;
	}
	.ddxx{
		cursor:pointer
	}
	.loader{
		position: fixed;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		z-index: 9999;
		background: #000 50% 50%;
		opacity: .3;
	}
</style>
<input type="hidden" id="nowhtml" value="navModel" class="navModel15-1">
	<div class="row-fluid">
	<div class="span12">
		<div class="portlet box ">
			<div class='loader' style="display: none;"></div>
			<div class="portlet-body">
				<div class="bbdd" id="bbdd" style="display: none;">
					<div class="ddhh">
						<span id="showTitle" style="margin-left: 70px;">商品更新中，请耐心等待。。。</span>
					</div>
				</div>
				<div style="float: left;width: 100%;">
					<div style="float: left;height:32px;line-height: 32px;margin-right: 5px">商品关键字:</div>
					<div class="ssinput" style="float: left;margin-bottom: 10px; position: relative;margin-left: 20px;">
						<input type="text" placeholder="商品关键字" class="skey" id="keyword" value="" style="width:100px;margin:0 5px;height:32px;line-height:32px;padding:0 5px;border-color:#e5e5e5">
					</div>
					<div style="float: left;height:32px;line-height: 32px;margin: 0 5px 0 60px">获取数量:</div>
					<div class="ssinput" style="float: left;margin-bottom: 10px; position: relative;margin-left: 20px;">
						<input type="number" placeholder="获取数量" class="skey" id="goodsNum" value="" style="width:100px;margin:0 5px;height:32px;line-height:32px;padding:0 5px;border-color:#e5e5e5">
					</div>
					<div style="float: left;height:32px;line-height: 32px;margin: 0 5px 0 60px">商品源:</div>
					<div style="float: left;margin-bottom: 10px; position: relative;">
						<select name="goods_source" id="goods_source" style="width: 120px;">
							<option value="0">请选择商品源</option>
							<option value="1">拼多多</option>
							<option value="2">京东</option>
						</select>
					</div>
					<div style="float: left;height:32px;line-height: 32px;margin: 0 5px 0 60px">分类:</div>
					<div  style="float: left;margin-bottom: 10px; position: relative;">
						<select name="goods_cats" id="goods_cats" style="width: 120px;">
							<option value="0">请选择分类</option>
							{if $externals}
								{volist name="externals" id="ex"}
									<option value="{$ex.id}">{$ex.cat_name}</option>
								{/volist}
							{/if}
						</select>
					</div>
				</div>
				<div style="float: left;height:32px;line-height: 32px;margin-right: 5px">佣金比例:</div>
				<div class="ssinput" style="margin-bottom: 10px; position: relative;width:100px;float:left;display: inline-block">
					<input type="number" placeholder="比例下限" class="skey" id="promotion_rate_low" value="" style="float:left;width:100px;float:left;margin:0 5px;height:32px;line-height:32px;padding:0 5px;border-color:#e5e5e5">
				</div>
				<div style="float: left;height:32px;line-height: 32px;margin-right: 5px; margin-left: 28px;">至</div>
				<div class="ssinput" style="margin-bottom: 10px; position: relative;width:100px;float:left;display: inline-block; margin-left:-45px;">
					<input type="number" placeholder="比例上限" class="skey" id="promotion_rate_high" value="" style="float:left;width:100px;float:left;margin-left: 50px;height:32px;line-height:32px;padding:0 5px;border-color:#e5e5e5">
				</div>
				<div style="float: left;height:32px;line-height: 32px;margin-right: 5px; margin-left: 100px;color: #a8bbc2">千分比</div>
				<div style="float: left;height:32px;line-height: 32px;margin-right: 5px; margin-left: 100px;" >商品券后价格:</div>
				<div class="ssinput" style="margin-bottom: 10px; position: relative;width:100px;float:left;display: inline-block">
					<input type="number" placeholder="券后价下限" class="skey" id="price_low" value="" style="float:left;width:100px;float:left;margin:0 5px;height:32px;line-height:32px;padding:0 5px;border-color:#e5e5e5">
				</div>
				<div style="float: left;height:32px;line-height: 32px;margin-right: 5px; margin-left: 28px;">至</div>
				<div class="ssinput" style="margin-bottom: 10px; position: relative;width:100px;float:left;display: inline-block; margin-left:-45px;">
					<input type="number" placeholder="券后价上限" class="skey" id="price_high" value="" style="float:left;width:100px;float:left;margin-left: 50px;height:32px;line-height:32px;padding:0 5px;border-color:#e5e5e5">
				</div>
				<div style="content: '';display:block;clear:left"></div>
				<div class="input-box" style="margin-bottom: 10px;">
					<div class="btn-group">
						<button  onclick="getGoods()" class="btn" style="float:left;background: #6671e4;color: #fff;margin-right: 10px;text-align: center">
						获取商品
						</button>
					</div>
					<div class="btn-group">
						<button  onclick="updateGoods()" class="btn" style="float:left;background: #6671e4;color: #fff;margin-right: 10px;text-align: center">
							更新商品
						</button>
					</div>
					<div class="btn-group">
						<button  class="btn" style="float:left;background: #fff;color: #333;border:1px solid #ebebeb;margin-right: 10px;text-align: center"  onclick="delall()">
							批量删除
						</button>
					</div>
				</div>
				<table id="sample_editable_1">
					<thead>
						<tr>
							<th style="width: 50px;">
								<input type="checkbox" id="all" />
							</th>
							<th style="width: 50px;">ID</th>
							<th style="width: 150px;">缩略图</th>
                            <th style="width: 150px;">商品名称</th>
							<th style="width: 100px;">商品价格</th>
							<th style="width: 100px;">佣金比例</th>
							<th style="width: 200px;">优惠券信息</th>
							<th style="width: 100px;">商品源</th>
							<th width="200px;">操作</th>
						</tr>
					</thead>
					<tbody>
						{if $hasGood}
							{volist name="goods" id="good"}
								<tr>
									<td>
										<input type="checkbox" name="csb"  value="{$good.id}"/>
									</td>
									<td>{$good.id}</td>
									<td><img src="{$good.goods_thumbnail_url}" style="width: 100px;" /></td>
                                    <td style="word-wrap: break-word;">{$good.name}</td>
									<td>{$good.min_group_price}元</td>
									<td>
										{if $good.type == 'pdd'}
											{$good.promotion_rate}‰
										{else}
											{$good.promotion_rate*10}‰
										{/if}
									</td>
									<td>
										{if $good.type == 'pdd'}
											面值：{$good.coupon_discount}元<br>
											剩余数量：{$good.coupon_remain_quantity}张<br>
											{if $good.coupon_end_time}
												结束时间：{$good.coupon_end_time|date="Y-m-d H:i:s",###}
											{/if}
										{else}
											{if $good.cou_link}
												面值：{$good.coupon_discount}元<br>
												{if $good.coupon_end_time}
												结束时间：{$good.coupon_end_time|date="Y-m-d H:i:s",###}
												{/if}
											{else}
												暂无优惠券
											{/if}
										{/if}
									</td>
									<td>
										{if $good.type == 'pdd'}
											拼多多
										{else}
											京东
										{/if}
									</td>
									<td >
										{if $good.is_sale == 2}
											<a href="{:Url('External/doGoods')}?appletid=<?php echo $_GET['appletid']?>&op=sale&gid={$good.id}"><button style="color: #438cdd;border:1px solid #438cdd;background:#fff;border-radius: 4px;padding: 1px 5px">上架</button></a>
										{else}
											<a href="{:Url('External/doGoods')}?appletid=<?php echo $_GET['appletid']?>&op=sale&gid={$good.id}"><button style="color: #438cdd;border:1px solid #438cdd;background:#fff;border-radius: 4px;padding: 1px 5px">下架</button></a>
										{/if}
										{if $good.is_index == 2}
											<a href="{:Url('External/doGoods')}?appletid=<?php echo $_GET['appletid']?>&op=toIndex&gid={$good.id}"><button style="color: #438cdd;border:1px solid #438cdd;background:#fff;border-radius: 4px;padding: 1px 5px">推荐首页</button></a>
										{else}
											<a href="{:Url('External/doGoods')}?appletid=<?php echo $_GET['appletid']?>&op=toIndex&gid={$good.id}"><button style="color: #438cdd;border:1px solid #438cdd;background:#fff;border-radius: 4px;padding: 1px 5px">取消推荐</button></a>
										{/if}
										<form action="{:Url('External/doGoods')}?appletid=<?php echo $_GET['appletid']?>&op=delete&gid={$good.id}"  method="post" enctype="multipart/form-data" onsubmit = "return del()">
											<button style="color: #d9534f;border:1px solid #d9534f;background:#fff;border-radius: 4px;padding: 1px 5px" type="submit">删除</button>
										</form>
									</td>
								</tr>
							{/volist}
						{else}
						<tr>
							<td colspan="9">暂无商品，请点击“获取商品”按钮获取商品！</td>
						</tr>
						{/if}


					</tbody>
				</table>
				<!-- 分页 -->
				<div>
					<div class="fenye_left">
						<!-- 一共查询到<font color="red" style="padding:0 10px;">{$count}</font>条数据 -->
					</div>
					<div class="fenye_right">
					{if $hasGood}
						{$goods->render()}
					{/if}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	function del(){
		if(confirm('该删除操作不可逆，请谨慎操作?')){
			return true;
		}else{
	        return false;
	    }
	}
	function search(){
        var cid=$("#cid option:selected").val();
        var key = $("#getnews").val();
        if(cid==false&&key==false){
              alert("请选择栏目或填写标题关键字");
		}else{
            location.href = "{:Url('Flashsale/pro')}?appletid=<?php echo $_GET['appletid']?>&key="+key+"&cid="+cid;
		}
    }
    $('#all').on('click',function(){
        if(this.checked) {
            $.uniform.update($("input[name='csb']").attr("checked", true));
        }else {
            $.uniform.update($("input[name='csb']").attr("checked", false));
        }
    });
    function delall(){
        var array1=new Array();
        $.each($("input[name='csb']"),function(){
            if(this.checked){
                array1.push($(this).val());
            }
        });
        if(array1.length>0){
            if(window.confirm('确定删除这些商品吗？')){
                location.href = "{:Url('External/delallm')}?appletid=<?php echo $_GET['appletid']?>&mpros="+array1;
            }else{
                return false;
            }
        }else{
            alert("您未选择删除对象");
            return false;
        }
    }

    function getGoods() {


		var keyword = $("#keyword").val();
		var goodsNum = $("#goodsNum").val();
		var goods_source = $("#goods_source").val();
		var goods_cats = $("#goods_cats").val();
		var promotion_rate_low = $("#promotion_rate_low").val();
		var promotion_rate_high = $("#promotion_rate_high").val();
        var price_low = $("#price_low").val();
        var price_high = $("#price_high").val();

		if(goods_source == 0){
		    alert('请选择商品源');
		    return false;
		}
		if(goodsNum && goodsNum <10){
            alert('商品数量大于10！');
            return false;
		}
		if(promotion_rate_low && !promotion_rate_high){
		    alert('请输入佣金比例上限');
		    return false;
		}
        if(!promotion_rate_low && promotion_rate_high){
            alert('请输入佣金比例下限');
            return false;
        }
        if(promotion_rate_low && promotion_rate_high && promotion_rate_low*1 > promotion_rate_high*1){
		    alert('佣金比例下限不能大于上限');
		    return false;
		}
		if(goods_source == 1){
			if(promotion_rate_low > 1000  ||  promotion_rate_high >1000){
			    alert('佣金比例值超出范围');
			    return false;
			}
		}else{
			if(promotion_rate_low > 100  ||  promotion_rate_high >100){
			    alert('佣金比例值超出范围');
			    return false;
			}
		}
		
		if(price_high && price_low && price_low*1 > price_high*1){
            alert('券后价上限不能小于券后价下限');
            return false;
		}

		if(goods_source == 2){
			if(!keyword && !goodsNum && !promotion_rate_low && !promotion_rate_high && !price_low && !price_high){
				alert('请至少输入一种搜索条件');
				return false;
			}
		}

        $(".loader").show();
        $("#showTitle").html('商品获取中，请耐心等待。。。');
        $("#bbdd").show();

        location.href = "{:Url('External/getGoodsFromExternal')}?appletid=<?php echo $_GET['appletid']?>&keyword="+keyword+"&goodsNum="+goodsNum+"&goods_source="+goods_source+"&goods_cats="+goods_cats+"&promotion_rate_low="+promotion_rate_low+"&promotion_rate_high="+promotion_rate_high+"&price_low="+price_low+"&price_high="+price_high;
    }

    function updateGoods() {
        $(".loader").show();
        $("#bbdd").show();
        var url = window.location.protocol+"//"+window.location.host + "/renewalCommodities?appletid=<?php echo $_GET['appletid']?>";
        location.href = url
    }

</script>
{include file="public/foot_more" /}